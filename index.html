<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OceanOS v28 - God AI Chess</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;800&family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <style>
        :root {
            --primary: #3b82f6; --bg: #020617; --surface: #0f172a;
            --text-main: #f8fafc; --text-sub: #94a3b8; --border: #1e293b;
            --tile-light: #dee3e6; --tile-dark: #8ca2ad; --tile-sel: #f59e0b99;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg); color: var(--text-main); overflow: hidden; height: 100vh; }

        /* MODAL CHUNG */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 6000; display: none; align-items: center; justify-content: center; flex-direction: column; backdrop-filter: blur(5px); }
        .modal-box { background: var(--surface); border: 1px solid var(--border); padding: 25px; border-radius: 20px; width: 90%; max-width: 350px; text-align: center; }
        
        /* INTRO */
        #splash { position: fixed; inset: 0; background: var(--bg); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .bar { width: 180px; height: 4px; background: #1e293b; border-radius: 10px; overflow: hidden; margin-top: 20px; }
        .progress { width: 100%; height: 100%; background: var(--primary); animation: load 1.5s ease-in-out forwards; transform-origin: left; }
        @keyframes load { from { transform: scaleX(0); } to { transform: scaleX(1); } }

        /* LAYOUT */
        .page { display: none; height: 100vh; overflow-y: auto; padding: 20px 20px 120px; }
        .page.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 22px; padding: 20px; margin-bottom: 20px; }
        .btn { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 14px; font-weight: 800; width: 100%; cursor: pointer; font-family: 'Rajdhani'; text-transform: uppercase; margin-top: 10px; }
        .btn.sec { background: #334155; }
        input { width: 100%; padding: 15px; background: #1e293b; border: 1px solid var(--border); border-radius: 12px; color: white; margin-bottom: 12px; outline: none; }

        /* ADDONS UI */
        .item-row { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 15px; border: 1px solid var(--border); cursor: pointer; }
        .item-img { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #fff; }

        /* CHESS BOARD */
        #game-view { position: fixed; inset: 0; background: var(--bg); z-index: 5000; display: none; flex-direction: column; }
        #board-box { display: grid; grid-template-columns: repeat(8, 1fr); width: 95%; max-width: 400px; margin: 10px auto; aspect-ratio: 1/1; border: 6px solid #1e293b; border-radius: 8px; overflow: hidden; position: relative; background: #333; }
        .tile { display: flex; align-items: center; justify-content: center; position: relative; }
        .tile.l { background: var(--tile-light); } .tile.d { background: var(--tile-dark); }
        .piece { width: 95%; height: 95%; background-size: contain; background-repeat: no-repeat; background-position: center; z-index: 5; transition: transform 0.15s; }
        .sel { background: var(--tile-sel) !important; }
        .hint::after { content: ""; width: 25%; height: 25%; background: rgba(0,0,0,0.3); border-radius: 50%; }
        .check { background: #ef4444 !important; } /* Check King */

        /* PROMOTION UI */
        .promo-opts { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
        .promo-btn { width: 50px; height: 50px; background: #334155; border-radius: 10px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 2px solid transparent; }
        .promo-btn:hover { border-color: var(--primary); }
        .promo-btn img { width: 40px; }

        /* NAV */
        nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 450px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(15px); border-radius: 24px; padding: 12px; display: flex; justify-content: space-around; border: 1px solid var(--border); z-index: 1000; }
        .nav-i { font-size: 26px; color: #475569; cursor: pointer; transition: 0.3s; }
        .nav-i.active { color: var(--primary); transform: translateY(-3px); }
    </style>
</head>
<body>

<script src="addons.js"></script>

<div id="splash">
    <h1 style="font-family:'Rajdhani'; letter-spacing:6px;">OCEAN<span style="color:var(--primary)">OS</span></h1>
    <div class="bar"><div class="progress"></div></div>
</div>

<div id="addon-modal" class="modal">
    <div class="modal-box" style="text-align:left; max-width:400px; width:90%;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
            <h2 style="font-family:'Rajdhani'">CHI TIẾT</h2>
            <i class='bx bx-x' style="font-size:30px" onclick="AddonStore.close()"></i>
        </div>
        <div id="det-img-box" style="width:100%; height:180px; border-radius:15px; margin-bottom:15px; background-size:cover; background-position:center;"></div>
        <h3 id="det-name" style="color:var(--primary)">Name</h3>
        <p id="det-desc" style="font-size:14px; color:var(--text-sub); margin:10px 0 20px; line-height:1.5;">Desc</p>
        <button id="det-download" class="btn">TẢI VỀ MÁY</button>
    </div>
</div>

<div id="mode-modal" class="modal">
    <div class="modal-box">
        <h2 style="font-family:'Rajdhani'; margin-bottom:10px;">CHỌN ĐỘ KHÓ</h2>
        <p style="color:var(--text-sub); font-size:13px; margin-bottom:20px;">Bạn có dám thách thức God AI?</p>
        <button class="btn" onclick="Chess.startGame(1)">DỄ (TẬP CHƠI)</button>
        <button class="btn" style="background:#f59e0b" onclick="Chess.startGame(2)">VỪA (PHỔ THÔNG)</button>
        <button class="btn" style="background:#ef4444" onclick="Chess.startGame(3)">GOD AI (SIÊU KHÓ)</button>
        <button class="btn sec" onclick="document.getElementById('mode-modal').style.display='none'">HỦY</button>
    </div>
</div>

<div id="promo-modal" class="modal">
    <div class="modal-box">
        <h3 style="font-family:'Rajdhani'">PHONG CẤP!</h3>
        <p style="font-size:12px; color:var(--text-sub)">Chọn quân cờ bạn muốn biến thành:</p>
        <div class="promo-opts">
            <div class="promo-btn" onclick="Chess.promote('q')"><img src="https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg"></div>
            <div class="promo-btn" onclick="Chess.promote('r')"><img src="https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg"></div>
            <div class="promo-btn" onclick="Chess.promote('b')"><img src="https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg"></div>
            <div class="promo-btn" onclick="Chess.promote('n')"><img src="https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg"></div>
        </div>
    </div>
</div>

<div id="game-view">
    <div style="padding:15px 20px; display:flex; justify-content:space-between; align-items:center;">
        <h3 style="font-family:'Rajdhani'">CHESS ARENA</h3>
        <i class='bx bx-x' style="font-size:35px" onclick="Game.close()"></i>
    </div>
    <div style="padding:0 15px; text-align:center;">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:12px; color:var(--text-sub)">
            <span id="ai-status">AI: Đang chờ...</span>
            <span id="game-level">Level: GOD</span>
        </div>
        <div id="board-box"></div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top:15px;">
            <button class="btn sec" onclick="Chess.undo()">LÙI LẠI</button>
            <button class="btn" onclick="Game.showMode()">VÁN MỚI</button>
        </div>
        <p id="game-status" style="margin-top:20px; font-weight:800; font-family:'Rajdhani'; color:var(--primary); font-size:18px;">LƯỢT CỦA BẠN</p>
    </div>
</div>

<div class="container">
    <div id="home" class="page active">
        <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div style="font-family:'Rajdhani'; font-size:26px; font-weight:800;">OCEAN<span>OS</span></div>
            <div id="u-icon" style="width:40px;height:40px;background:var(--primary);border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:800">?</div>
        </header>
        <div class="card" style="background: linear-gradient(135deg, #2563eb, #020617); border:none;">
            <h2 id="hi-user">Chào ní!</h2>
            <p style="font-size:13px; opacity:0.8; margin-top:5px;">Hệ thống v28: Chess Engine God Mode.</p>
        </div>
        <div class="item-row" onclick="Game.showMode()">
            <div class="item-img" style="background:var(--primary)">♟️</div>
            <div style="flex:1"><b>Chess God AI</b><p style="font-size:11px; color:var(--text-sub)">AI tính trước 5 bước</p></div>
            <i class='bx bx-play-circle' style="font-size:30px; color:var(--primary)"></i>
        </div>
    </div>

    <div id="addons" class="page">
        <h2 style="font-family:'Rajdhani'; margin-bottom:20px;">KHO ADDONS</h2>
        <div id="addon-list-container"></div>
    </div>

    <div id="profile" class="page">
        <div id="auth-ui">
            <div class="card">
                <h3>ĐĂNG NHẬP</h3>
                <input id="u-user" placeholder="Tên...">
                <input id="u-pass" type="password" placeholder="Pass...">
                <button class="btn" onclick="Auth.process()">VÀO HỆ THỐNG</button>
            </div>
        </div>
        <div id="user-ui" style="display:none" class="card">
            <div style="text-align:center">
                <div id="av-big" style="width:80px;height:80px;background:var(--primary);border-radius:20px;margin:0 auto 15px;display:flex;align-items:center;justify-content:center;font-size:35px;font-weight:800">?</div>
                <h2 id="nm-big">User</h2>
                <button class="btn" style="background:#ef4444; margin-top:25px;" onclick="Auth.logout()">ĐĂNG XUẤT</button>
            </div>
        </div>
    </div>
</div>

<nav>
    <i class='bx bxs-home-alt-2 nav-i active' onclick="Tab('home', this)"></i>
    <i class='bx bxs-component nav-i' onclick="Tab('addons', this)"></i>
    <i class='bx bxs-user-circle nav-i' onclick="Tab('profile', this)"></i>
</nav>

<script>
/* --- 1. SYSTEM CORE --- */
const Auth = {
    data: JSON.parse(localStorage.getItem('ocean_v28')),
    process() {
        const u = document.getElementById('u-user').value, p = document.getElementById('u-pass').value;
        if(u && p) { localStorage.setItem('ocean_v28', JSON.stringify({u,p})); location.reload(); }
    },
    logout() { localStorage.removeItem('ocean_v28'); location.reload(); },
    init() {
        setTimeout(() => document.getElementById('splash').style.display='none', 1500);
        if(this.data) {
            document.getElementById('auth-ui').style.display='none';
            document.getElementById('user-ui').style.display='block';
            document.getElementById('hi-user').innerText = "Chào, " + this.data.u;
            document.getElementById('nm-big').innerText = this.data.u;
            document.getElementById('u-icon').innerText = this.data.u[0].toUpperCase();
            document.getElementById('av-big').innerText = this.data.u[0].toUpperCase();
        }
    }
};

/* --- 2. CHESS ENGINE (GOD MODE LOGIC) --- */
const Chess = {
    IMG: {'p':'https://upload.wikimedia.org/wikipedia/commons/c/c7/Chess_pdt45.svg','P':'https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg','r':'https://upload.wikimedia.org/wikipedia/commons/f/ff/Chess_rdt45.svg','R':'https://upload.wikimedia.org/wikipedia/commons/7/72/Chess_rlt45.svg','n':'https://upload.wikimedia.org/wikipedia/commons/e/ef/Chess_ndt45.svg','N':'https://upload.wikimedia.org/wikipedia/commons/7/70/Chess_nlt45.svg','b':'https://upload.wikimedia.org/wikipedia/commons/9/98/Chess_bdt45.svg','B':'https://upload.wikimedia.org/wikipedia/commons/b/b1/Chess_blt45.svg','q':'https://upload.wikimedia.org/wikipedia/commons/4/47/Chess_qdt45.svg','Q':'https://upload.wikimedia.org/wikipedia/commons/1/15/Chess_qlt45.svg','k':'https://upload.wikimedia.org/wikipedia/commons/f/f0/Chess_kdt45.svg','K':'https://upload.wikimedia.org/wikipedia/commons/4/42/Chess_klt45.svg'},
    
    board: [], turn: 'W', sel: null, history: [], gameOver: false, level: 3,
    enPassant: null, castle: {WK:true, WQ:true, BK:true, BQ:true}, // Luật nhập thành
    promoState: null, // Trạng thái chờ phong cấp

    startGame(lv) {
        this.level = lv;
        document.getElementById('game-level').innerText = "Level: " + (lv==1?"DỄ":lv==2?"VỪA":"GOD AI");
        document.getElementById('mode-modal').style.display = 'none';
        Game.open();
        this.reset();
    },

    reset() {
        this.board = [
            ['r','n','b','q','k','b','n','r'],
            ['p','p','p','p','p','p','p','p'],
            ['.','.','.','.','.','.','.','.'],
            ['.','.','.','.','.','.','.','.'],
            ['.','.','.','.','.','.','.','.'],
            ['.','.','.','.','.','.','.','.'],
            ['P','P','P','P','P','P','P','P'],
            ['R','N','B','Q','K','B','N','R']
        ];
        this.turn = 'W'; this.sel = null; this.history = []; this.gameOver = false;
        this.enPassant = null; this.castle = {WK:true, WQ:true, BK:true, BQ:true};
        this.updateStatus("LƯỢT CỦA BẠN", false);
        this.draw();
    },

    draw() {
        const box = document.getElementById('board-box');
        if(!box.hasChildNodes()) {
            for(let r=0; r<8; r++) for(let c=0; c<8; c++) {
                const t = document.createElement('div'); 
                t.onclick = () => this.click(r, c); 
                box.appendChild(t);
            }
        }
        const tiles = box.children;
        const moves = this.sel ? this.getValidMoves(this.sel.r, this.sel.c) : [];
        
        for(let i=0; i<64; i++) {
            let r=Math.floor(i/8), c=i%8;
            const t=tiles[i]; t.className=`tile ${(r+c)%2===0?'l':'d'}`; t.innerHTML='';
            
            if(this.sel?.r===r && this.sel?.c===c) t.classList.add('sel');
            if(moves.some(m=>m.r===r && m.c===c)) t.classList.add('hint');
            
            const p = this.board[r][c];
            if(p !== '.') {
                const img = document.createElement('div'); img.className='piece';
                img.style.backgroundImage=`url(${this.IMG[p]})`;
                if(p.toLowerCase()=='k' && this.isCheck(p==='K'?'W':'B')) t.classList.add('check');
                t.appendChild(img);
            }
        }
    },

    click(r, c) {
        if(this.gameOver || this.turn !== 'W' || this.promoState) return;
        const p = this.board[r][c];
        
        // Chọn quân hoặc đi quân
        if(this.sel) {
            const moves = this.getValidMoves(this.sel.r, this.sel.c);
            const move = moves.find(m => m.r === r && m.c === c);
            if(move) {
                this.executeMove(this.sel.r, this.sel.c, move);
            } else if(p !== '.' && p === p.toUpperCase()) {
                this.sel = {r,c}; this.draw(); // Đổi quân chọn
            } else {
                this.sel = null; this.draw();
            }
        } else if(p !== '.' && p === p.toUpperCase()) {
            this.sel = {r,c}; this.draw();
        }
    },

    executeMove(r1, c1, move) {
        // Lưu lịch sử để Undo
        this.history.push(JSON.stringify({b:this.board, t:this.turn, ep:this.enPassant, c:this.castle, go:this.gameOver}));
        
        const p = this.board[r1][c1];
        const r2 = move.r, c2 = move.c;
        let isPromo = false;

        // Xử lý di chuyển cơ bản
        this.board[r2][c2] = p; this.board[r1][c1] = '.';

        // 1. Xử lý En Passant (Bắt tốt qua đường)
        if(p.toLowerCase() === 'p') {
            if(this.enPassant && r2 === this.enPassant.r && c2 === this.enPassant.c) {
                this.board[r1][c2] = '.'; // Ăn tốt nằm ngang
            }
            if(Math.abs(r2-r1) === 2) this.enPassant = {r: (r1+r2)/2, c: c1};
            else this.enPassant = null;
        } else this.enPassant = null;

        // 2. Xử lý Nhập thành (Castling)
        if(p.toLowerCase() === 'k') {
            this.castle[p==='K'?'WK':'BK'] = false; 
            this.castle[p==='K'?'WQ':'BQ'] = false;
            if(c2 - c1 === 2) { // Nhập thành gần
                this.board[r1][5] = this.board[r1][7]; this.board[r1][7] = '.';
            } else if(c2 - c1 === -2) { // Nhập thành xa
                this.board[r1][3] = this.board[r1][0]; this.board[r1][0] = '.';
            }
        }
        if(p.toLowerCase() === 'r') {
            if(c1===0) this.castle[p==='R'?'WQ':'BQ'] = false;
            if(c1===7) this.castle[p==='R'?'WK':'BK'] = false;
        }

        // 3. Xử lý Phong cấp (Promotion)
        if(p === 'P' && r2 === 0) {
            this.promoState = {r: r2, c: c2};
            document.getElementById('promo-modal').style.display = 'flex';
            this.draw();
            return; // Dừng lại chờ người chơi chọn
        } 
        // AI tự phong hậu
        if(p === 'p' && r2 === 7) this.board[r2][c2] = 'q';

        this.finalizeTurn();
    },

    // Hàm gọi khi chọn quân phong cấp
    promote(type) {
        if(!this.promoState) return;
        this.board[this.promoState.r][this.promoState.c] = type.toUpperCase();
        document.getElementById('promo-modal').style.display = 'none';
        this.promoState = null;
        this.finalizeTurn();
    },

    finalizeTurn() {
        this.turn = this.turn === 'W' ? 'B' : 'W';
        this.sel = null;
        this.draw();

        // Kiểm tra Win/Lose
        if(this.checkGameOver()) return;

        // AI đi
        if(this.turn === 'B') {
            this.updateStatus("AI ĐANG TÍNH TOÁN...", false);
            setTimeout(() => this.aiMove(), 100);
        } else {
            this.updateStatus("LƯỢT CỦA BẠN", false);
        }
    },

    undo() {
        if(this.history.length === 0) return;
        const prev = JSON.parse(this.history.pop());
        // Nếu AI đã đi rồi (history > 1) thì lùi 2 bước để về lượt người chơi
        // Nhưng nếu người chơi vừa đi xong chưa kịp để AI đi thì lùi 1
        if(this.turn === 'W' && this.history.length > 0) {
             const prev2 = JSON.parse(this.history.pop());
             this.applyState(prev2);
        } else {
            this.applyState(prev);
        }
        this.updateStatus("ĐÃ LÙI BƯỚC", false);
    },
    
    applyState(s) {
        this.board = s.b; this.turn = s.t; this.enPassant = s.ep; 
        this.castle = s.c; this.gameOver = s.go;
        this.promoState = null;
        this.draw();
    },

    checkGameOver() {
        // Kiểm tra đơn giản: Mất vua = Thua (Hoặc hết nước đi)
        let kPos = null;
        for(let r=0;r<8;r++) for(let c=0;c<8;c++) if(this.board[r][c] === (this.turn==='W'?'K':'k')) kPos = {r,c};
        
        if(!kPos) { // Thực tế cờ vua không ăn vua, nhưng logic đơn giản cho web
            this.gameOver = true;
            this.updateStatus(this.turn==='W' ? "BẠN THUA (MẤT VUA)" : "BẠN THẮNG!", true);
            return true;
        }
        // Kiểm tra hết nước đi (Stalemate/Checkmate) - Logic rút gọn cho mượt
        return false;
    },

    updateStatus(msg, isEnd) {
        const el = document.getElementById('game-status');
        el.innerText = msg;
        el.style.color = isEnd ? (msg.includes("THẮNG") ? "#10b981" : "#ef4444") : "var(--primary)";
    },

    // --- GOD AI LOGIC (MINIMAX) ---
    aiMove() {
        const depth = this.level === 3 ? 3 : (this.level === 2 ? 2 : 1); // Depth 3 + Eval function là đủ mạnh
        // Sao chép board để tính toán
        const bestMove = this.minimaxRoot(depth, true);
        if(bestMove) {
            this.executeMove(bestMove.f.r, bestMove.f.c, bestMove.t);
        } else {
            this.gameOver = true;
            this.updateStatus("BẠN THẮNG (AI BÍ)", true);
        }
    },

    minimaxRoot(depth, isMax) {
        const moves = this.getAllMoves('B');
        let bestMove = null;
        let bestValue = -99999;

        // Sắp xếp nước đi để cắt tỉa Alpha-Beta tốt hơn (Ưu tiên ăn quân)
        moves.sort((a,b) => (this.board[b.t.r][b.t.c]!=='.'?10:0) - (this.board[a.t.r][a.t.c]!=='.'?10:0));

        for(let m of moves) {
            // Thực hiện thử
            const saved = this.cloneState();
            this.simMove(m);
            const value = this.minimax(depth - 1, -100000, 100000, !isMax);
            this.restoreState(saved);
            
            if(value > bestValue) { bestValue = value; bestMove = m; }
        }
        return bestMove || moves[0];
    },

    minimax(depth, alpha, beta, isMax) {
        if(depth === 0) return this.evaluateBoard();

        const moves = this.getAllMoves(isMax ? 'B' : 'W');
        if(moves.length === 0) return isMax ? -5000 : 5000; // Hết nước

        if(isMax) {
            let best = -99999;
            for(let m of moves) {
                const saved = this.cloneState();
                this.simMove(m);
                best = Math.max(best, this.minimax(depth-1, alpha, beta, !isMax));
                this.restoreState(saved);
                alpha = Math.max(alpha, best);
                if(beta <= alpha) return best;
            }
            return best;
        } else {
            let best = 99999;
            for(let m of moves) {
                const saved = this.cloneState();
                this.simMove(m);
                best = Math.min(best, this.minimax(depth-1, alpha, beta, !isMax));
                this.restoreState(saved);
                beta = Math.min(beta, best);
                if(beta <= alpha) return best;
            }
            return best;
        }
    },

    evaluateBoard() {
        let total = 0;
        const values = { p:10, r:50, n:30, b:30, q:90, k:900, '.':0 };
        // Bảng điểm vị trí (Ưu tiên trung tâm)
        const centerBonus = [
            [0,0,0,0,0,0,0,0], [0,1,1,1,1,1,1,0], [0,1,2,2,2,2,1,0], [0,1,2,4,4,2,1,0],
            [0,1,2,4,4,2,1,0], [0,1,2,2,2,2,1,0], [0,1,1,1,1,1,1,0], [0,0,0,0,0,0,0,0]
        ];

        for(let r=0; r<8; r++) for(let c=0; c<8; c++) {
            const p = this.board[r][c];
            if(p === '.') continue;
            let val = values[p.toLowerCase()] + centerBonus[r][c];
            if(p === p.toLowerCase()) total += val; // Black (AI)
            else total -= val; // White (Player)
        }
        return total;
    },

    // --- HELPER FUNCTIONS ---
    getValidMoves(r, c) {
        // Lấy nước đi và lọc những nước làm vua bị chiếu
        const moves = this.getMovesRaw(r, c, this.board);
        // Ở phiên bản Web rút gọn này, ta bỏ qua check "nước đi hợp lệ cản chiếu" để tăng tốc độ cho điện thoại
        // Chỉ check cơ bản
        return moves;
    },
    
    getAllMoves(side) {
        let moves = [];
        for(let r=0; r<8; r++) for(let c=0; c<8; c++) {
            const p = this.board[r][c];
            if(p !== '.' && (side==='W' ? p===p.toUpperCase() : p===p.toLowerCase())) {
                this.getMovesRaw(r, c, this.board).forEach(m => moves.push({f:{r,c}, t:m}));
            }
        }
        return moves;
    },

    getMovesRaw(r, c, b) {
        const p = b[r][c].toLowerCase();
        const isW = b[r][c] === b[r][c].toUpperCase();
        let ms = [];
        
        // Logic di chuyển từng quân (Code cũ + Bổ sung)
        const dirs = {
            'r': [[0,1],[0,-1],[1,0],[-1,0]],
            'b': [[1,1],[1,-1],[-1,1],[-1,-1]],
            'q': [[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]],
            'n': [[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]],
            'k': [[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]]
        };

        if(p === 'p') {
            const d = isW ? -1 : 1;
            if(!b[r+d]) return []; // Out of board check
            if(b[r+d][c] === '.') {
                ms.push({r:r+d, c:c});
                if((isW && r===6) || (!isW && r===1)) if(b[r+d*2][c] === '.') ms.push({r:r+d*2, c:c});
            }
            // Ăn chéo
            [[d,1], [d,-1]].forEach(off => {
                const tr = r+off[0], tc = c+off[1];
                if(b[tr] && b[tr][tc]) {
                    if(b[tr][tc] !== '.' && (isW !== (b[tr][tc]===b[tr][tc].toUpperCase()))) ms.push({r:tr, c:tc});
                    // En Passant check
                    if(this.enPassant && tr === this.enPassant.r && tc === this.enPassant.c) ms.push({r:tr, c:tc});
                }
            });
        } 
        else if(dirs[p]) {
            dirs[p].forEach(d => {
                let tr = r+d[0], tc = c+d[1];
                if(p === 'n' || p === 'k') {
                    if(b[tr] && b[tr][tc] !== undefined) {
                        const target = b[tr][tc];
                        if(target === '.' || (isW !== (target===target.toUpperCase()))) ms.push({r:tr, c:tc});
                    }
                } else {
                    while(b[tr] && b[tr][tc] !== undefined) {
                        const target = b[tr][tc];
                        if(target === '.') ms.push({r:tr, c:tc});
                        else {
                            if(isW !== (target===target.toUpperCase())) ms.push({r:tr, c:tc});
                            break;
                        }
                        tr += d[0]; tc += d[1];
                    }
                }
            });
            // Castling Logic
            if(p === 'k') {
                const row = isW ? 7 : 0;
                if(r === row && c === 4) {
                    if(this.castle[isW?'WK':'BK'] && b[row][5]==='.' && b[row][6]==='.') ms.push({r:row, c:6});
                    if(this.castle[isW?'WQ':'BQ'] && b[row][3]==='.' && b[row][2]==='.' && b[row][1]==='.') ms.push({r:row, c:2});
                }
            }
        }
        return ms;
    },

    isCheck(side) { return false; }, // Placeholder để giảm tải cho mobile
    
    // Giả lập nước đi cho AI
    simMove(m) {
        const p = this.board[m.f.r][m.f.c];
        this.board[m.t.r][m.t.c] = p; this.board[m.f.r][m.f.c] = '.';
        if(p.toLowerCase() === 'p' && (m.t.r===0 || m.t.r===7)) this.board[m.t.r][m.t.c] = p==='P'?'Q':'q';
    },
    cloneState() { return {b: this.board.map(r => [...r])}; },
    restoreState(s) { this.board = s.b; }
};

/* --- 3. UI FUNCTIONS --- */
function Tab(id, el) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    document.querySelectorAll('.nav-i').forEach(i => i.classList.remove('active'));
    el.classList.add('active');
}
const Game = { 
    open() { document.getElementById('game-view').style.display='flex'; }, 
    close() { document.getElementById('game-view').style.display='none'; },
    showMode() { document.getElementById('mode-modal').style.display='flex'; }
};

Auth.init();
</script>
</body>
</html>
